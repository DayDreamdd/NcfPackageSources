@page
@using Senparc.Ncf.Core.Models
@using Senparc.Ncf.XncfBase
@using Senparc.CO2NET.Extensions;
@using Senparc.Ncf.XncfBase.FunctionRenders
@using Senparc.Ncf.XncfBase.Functions

@model IndexModel
@{
    ViewData["Title"] = "测试页";
}

<div class="text-center">
    <h1 class="display-4">NeuCharFramework</h1>
    <p>
        注意：此项目是 NCF 基础包的集成测试项目，仅验证编译是否能通过，无参考意义，并非 NCF 模板项目！
        <a href="https://github.com/NeuCharFramework/NCF/">点击这里</a> 查看可直接安装使用的 NCF 模板项目！
    </p>
    <hr />
    <h3>XNCF 检查</h3>
    <table class="table table-striped table-hover #table-responsive table-sm" style="word-break: normal;">
        <thead> <tr><th>名称（Uid）</th><th>注册优先级</th><th>版本</th><th>数据库支持</th><th>线程支持</th><th>Function 支持</th></tr></thead>
        <tbody>
            @foreach (var registerInfo in Model.XncfRegisterList)
            {
                var item = registerInfo.XncfRegister;
                <tr>
                    <td>
                        @item.MenuName / @item.Name
                        <br>（@item.Uid）
                    </td>
                    <td>
                        @{
                            var orderAttr = item.GetType().GetCustomAttributes(typeof(XncfOrderAttribute), true).FirstOrDefault() as XncfOrderAttribute;
                            if (orderAttr == null)
                            {
                                <text>默认</text>
                            }
                            else
                            {
                                <text>@orderAttr.Order</text>
                            }
                        }
                    </td>
                    <td>v@(item.Version)</td>
                    <td>
                        @if (item is IXncfDatabase db)
                        {
                            @* var multipleDatabasePool = MultipleDatabasePool.Instance;
                    var dbType = multipleDatabasePool.GetXncfDbContextType(db.GetType()); *@
                            var dbType = db.TryGetXncfDatabaseDbContextType;
                            var parentType = dbType.BaseType;
                            <span title="当前使用数据库：@dbType.Name">@parentType.Name</span>
                        }
                        else
                        {
                            <test>不支持</test>
                        }
                    </td>
                    <td>
                        <p>
                            @if (item.RegisteredThreadInfo.Count() == 0)
                            {
                                <text>不支持</text>
                            }
                            else
                            {
                                foreach (var thread in item.RegisteredThreadInfo)
                                {
                                    <text>@thread.Key.Name / @thread.Value.ThreadState</text>
                                    <br />
                                }
                            }
                        </p>
                    </td>
                    <td class="text-left">
                        @foreach (var function in registerInfo.RegisterFunctionInfoList)
                        {
                            <p><srtong>名称：@function.Name</srtong></p>
                            <p><srtong>说明：@function.Description</srtong></p>
                            <p>
                                参数：
                            </p>

                            <ul>
                                @foreach (var paraInfo in function.FunctionParameterInfoList)
                                {
                                    <li>
                                        参数名称：@paraInfo.Name<br />
                                        类型：@paraInfo.SystemType
                                        @if (paraInfo.IsRequired)
                                        {
                                            <span>（必须）</span>
                                        }
                                        <br />
                                        显示标题：@paraInfo.Title<br />
                                        说明：@paraInfo.Description<br />
                                        @if (paraInfo.ParameterType != ParameterType.Text)
                                        {
                                            <p>列表类型：@paraInfo.ParameterType</p>
                                            <p>选项：</p>
                                            <ol class="pl-5">
                                                @foreach (var selection in paraInfo.SelectionList.Items)
                                                {
                                                    <li>
                                                        <span>显示名称：@selection.Text</span><br />
                                                        <span>值：@selection.Value</span>
                                                        @if (selection.DefaultSelected)
                                                        {
                                                            <span>（默认）</span>
                                                        }
                                                        <br />
                                                        <span>说明：@selection.Note</span>
                                                    </li>
                                                }
                                            </ol>

                                        }
                                        <br />


                                    </li>
                                }

                            </ul>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
